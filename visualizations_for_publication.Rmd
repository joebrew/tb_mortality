---
title: "Tables and figures for publications"
author: "Alberto Garcia-Basteiro and Joe Brew"
date: "March 28, 2017"
fig_height: 6
fig_width: 8
# output: ioslides_presentation

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(comment = NA, 
               echo = FALSE, 
               warning = FALSE, 
               message = FALSE, 
               error = TRUE, 
               cache = FALSE)
```

```{r, results = 'hide'}
# Packages
library(ggplot2)
library(cism)
library(rworldmap)
library(rgeos)
library(maptools)
library(rgdal)
library(tidyr)
library(RColorBrewer)
library(broom)

# Read in data
source('make_wide.R')

# Source helpers
source('helpers.R')


# Make a region specific data frame
df_region <- df %>%
  group_by(who_region) %>%
  summarise(population = sum(gb_e_pop_num, na.rm = TRUE),
            i_both_all_htb_nd = weighted.mean(i_both_all_htb_nd,
                            w = gb_e_pop_num,
                            na.rm = TRUE),
                i_both_all_tb_nd = weighted.mean(i_both_all_tb_nd,
                            w = gb_e_pop_num,
                            na.rm = TRUE),
                i_both_all_tbtotal_nd = weighted.mean(i_both_all_tbtotal_nd,
                            w = gb_e_pop_num,
                            na.rm = TRUE),
                w_both_all_htb_nd = weighted.mean(w_both_all_htb_nd,
                            w = gb_e_pop_num,
                            na.rm = TRUE),
                w_both_all_tb_nd = weighted.mean(w_both_all_tb_nd,
                            w = gb_e_pop_num,
                            na.rm = TRUE),
                w_both_all_tbtotal_nd = weighted.mean(w_both_all_tbtotal_nd,
                            w = gb_e_pop_num,
                            na.rm = TRUE),
            case_fatality_rate_2015_adjusted = 
              weighted.mean(case_fatality_rate_2015_adjusted,
                            w = gb_e_pop_num,
                            na.rm = TRUE),
            relative_difference = 
              weighted.mean(relative_difference,
                            w = gb_e_pop_num,
                            na.rm = TRUE),
            # i_over_w = weighted.mean(i_over_w,
            #                          w = gb_e_pop_num,
            #                          na.rm = TRUE),
            # w_over_i = weighted.mean(w_over_i,
            #                          w = gb_e_pop_num,
            #                          na.rm = TRUE),
            stand_dif = weighted.mean(stand_dif,
                                      w = gb_e_pop_num,
                                      na.rm = TRUE))


  

# Get world map
world <- readOGR('shp/world', 'ne_110m_admin_0_countries')
```


```{r}

```

# Tables

## Descriptive tables

### Global differences by:, age, sex, world region

```{r}
temp <- df %>%
  dplyr::select(country,
                gb_e_pop_num,
                i_both_all_htb_nd,
                i_both_all_tb_nd,
                i_both_all_tbtotal_nd,
                w_both_all_htb_nd,
                w_both_all_tb_nd,
                w_both_all_tbtotal_nd)
rows1 <- temp[0,]
for (j in 3:ncol(temp)){
  rows1[1,j] <- sum(x = temp[,j], na.rm = TRUE)
}
rows1$country <- rows1$gb_e_pop_num <- NULL

# Make a function for side-by-siding i and w data
side_by_side <- function(data){
  left <- data[,(substr(names(data), 1, 2) == 'i_')]
  right <- data[,(substr(names(data), 1, 2) == 'w_')]
  out <- data.frame(value = NA, cbind(t(left), t(right)))
  names(out) <- c('Value', 'IHME', 'WHO')
  out$Value <- row.names(out)
  row.names(out) <- NULL
  return(out)
}

rows1 <- side_by_side(rows1)
# Clean up names
clean_up <- function(x){
  ifelse(x == 'i_both_all_htb_nd',
         'HIV+TB only',
         ifelse(x == 'i_both_all_tb_nd',
                'TB only',
                ifelse(x == 'i_both_all_tbtotal_nd',
                       'Total TB',
                       NA)))
}
rows1$Value <- clean_up(rows1$Value)
rows1$Region <- ''
rows1 <- rows1 %>%
  dplyr::select(Region, Value, IHME, WHO)
################################
# Get second part = WHO region
temp <- df_region %>%
  dplyr::select(who_region,
                i_both_all_htb_nd,
                i_both_all_tb_nd,
                i_both_all_tbtotal_nd,
                w_both_all_htb_nd,
                w_both_all_tb_nd,
                w_both_all_tbtotal_nd)

results_list <- list()
for (i in 1:nrow(temp)){
  result <- data.frame(region = temp$who_region[i],
                       side_by_side(temp[i,]))
  results_list[[i]] <- result
}
result <- bind_rows(results_list)
rows2 <- result
rows2$Value <- clean_up(rows2$Value)
names(rows2)[1] <- 'Region'


######################

#### ROWS 3 age

# Haven't created these variables (w_both_15plus_htb_nd)

rows3 <- expand.grid(Value = c('Total TB',
                               'TB only',
                               'HIV+TB only'),
                     Region = c('Adults', 'Children'),
                    IHME = NA,
                    WHO = NA)
rows3 <- rows3 %>%
  dplyr::select(Region, Value, IHME, WHO)
rows3[rows3$Region == 'Adults' &
             rows3$Value == 'TB only',
      c('IHME', 'WHO')] <-
  c(sum(df$i_both_15plus_tb_nd, na.rm = TRUE),
    sum(df$w_both_15plus_tb_nd, na.rm = TRUE))
rows3[rows3$Region == 'Children' &
             rows3$Value == 'TB only',
      c('IHME', 'WHO')] <-
  c(sum(df$i_both_014_tb_nd, na.rm = TRUE),
    sum(df$w_both_014_tb_nd, na.rm = TRUE))


## By sex
by_sex <- 
  expand.grid(Value = c('Total TB',
                               'TB only',
                               'HIV+TB only'),
                     Region = c('Male', 'Female'),
                    IHME = NA,
                    WHO = NA,
              Dif = NA)
by_sex[by_sex$Value == 'Total TB' &
              by_sex$Region == 'Female',
       c('IHME', 'WHO')] <- c(sum(df$i_f_15plus_tb_nd,na.rm = TRUE) +
                                sum(df$i_f_15plus_htb_nd,na.rm = TRUE),
                              sum(df$w_f_15plus_tb_nd,na.rm = TRUE) +
                                sum(df$w_f_15plus_htb_nd,na.rm = TRUE))
by_sex[by_sex$Value == 'Total TB' &
              by_sex$Region == 'Male',
       c('IHME', 'WHO')] <- c(sum(df$i_m_15plus_tb_nd,na.rm = TRUE) +
                                sum(df$i_m_15plus_htb_nd,na.rm = TRUE),
                              sum(df$w_m_15plus_tb_nd,na.rm = TRUE) +
                                sum(df$w_m_15plus_htb_nd,na.rm = TRUE))

by_sex[by_sex$Value == 'TB only' &
              by_sex$Region == 'Female',
       c('IHME', 'WHO')] <- c(sum(df$i_f_15plus_tb_nd,na.rm = TRUE),
                              sum(df$w_f_15plus_tb_nd,na.rm = TRUE))
by_sex[by_sex$Value == 'TB only' &
              by_sex$Region == 'Male',
       c('IHME', 'WHO')] <- c(sum(df$i_m_15plus_tb_nd,na.rm = TRUE),
                              sum(df$w_m_15plus_tb_nd,na.rm = TRUE))

by_sex[by_sex$Value == 'HIV+TB only' &
              by_sex$Region == 'Female',
       c('IHME', 'WHO')] <- c(sum(df$i_f_15plus_htb_nd,na.rm = TRUE),
                              sum(df$w_f_15plus_htb_nd,na.rm = TRUE))
by_sex[by_sex$Value == 'HIV+TB only' &
              by_sex$Region == 'Male',
       c('IHME', 'WHO')] <- c(sum(df$i_m_15plus_htb_nd,na.rm = TRUE),
                              sum(df$w_m_15plus_htb_nd,na.rm = TRUE))
  

rows3[rows3$Region == 'Adults' &
             rows3$Value == 'HIV+TB only',
      c('IHME', 'WHO')] <-
  c(sum(df$i_both_15plus_htb_nd, na.rm = TRUE),
    sum(df$w_both_15plus_htb_nd, na.rm = TRUE))
rows3[rows3$Region == 'Children' &
             rows3$Value == 'HIV+TB only',
      c('IHME', 'WHO')] <-
  c(sum(df$i_both_014_htb_nd, na.rm = TRUE),
    sum(df$w_both_014_htb_nd, na.rm = TRUE))

# Get totals for row 3
rows3[rows3$Region == 'Children' &
             rows3$Value == 'Total TB',
      c('IHME', 'WHO')] <-
  c(rows3 %>%
      filter(Region == 'Children') %>%
      summarise(IHME = sum(IHME, na.rm = TRUE),
                WHO = sum(WHO, na.rm = TRUE)))
rows3[rows3$Region == 'Adults' &
             rows3$Value == 'Total TB',
      c('IHME', 'WHO')] <-
  c(rows3 %>%
      filter(Region == 'Adults') %>%
      summarise(IHME = sum(IHME, na.rm = TRUE),
                WHO = sum(WHO, na.rm = TRUE)))

x <-
  bind_rows(rows1,
      rows2,
      rows3,
      by_sex)
x$x <- NA
x$x[1:3] <- 'total'
x$x[4:21] <- 'region'
x$x[22:27] <- 'age'
x$x[28:33] <- 'sex'
x <- x %>% arrange(x, Region, Value)
x <- rbind(x[x$x == 'total',],
           x[x$x == 'region',],
           x[x$x == 'age',],
           x[x$x == 'sex',])
x$x <- NULL
x[1,1] <- 'Total'
x$flag <- FALSE
for (i in 2:nrow(x)){
  if(x[i,1] == x[i-1, 1]){
    x[i,'flag'] <- TRUE
  }
}
x[,1][x$flag] <- ''
x$flag <- NULL
names(x)[1:2] <- c(' ', '  ')


x$Dif <- x$WHO / x$IHME
x$`% difference (WHO / IHME)` <- x$Dif
x$Dif <- x$IHME / x$WHO
x$`% difference (IHME / WHO)` <- x$Dif
x$`% difference (WHO / IHME)` <-
  (x$`% difference (WHO / IHME)` * 100) - 100
x$`% difference (IHME / WHO)` <-
  (x$`% difference (IHME / WHO)` * 100) - 100

x$`% difference (IHME / WHO)` <- paste0(round(x$`% difference (IHME / WHO)`, digits = 2), '%')
x$`% difference (WHO / IHME)` <- paste0(round(x$`% difference (WHO / IHME)`, digits = 2), '%')

# Add a absolute difference column
x$Dif <- abs(x$IHME - x$WHO)

row.names(x) <- 1:nrow(x)
x <- x[c(1:3, # total
         c(22:27), # adults then children
         c(28:33),# add by sex here
         7:21), # by region
       ]

x$IHME <- round(x$IHME)
x$WHO <- round(x$WHO)

knitr::kable(x, row.names = FALSE)

```


## Analytical tables 


Table with model output for estimating likelihood or magnitude of difference in estimates by HIV, age, sex, and region.

This section is unfinished.

```{r}
fit <- lm(stand_dif ~ who_region, 
          data = df %>%
            filter(!is.na(stand_dif),
                   is.finite(stand_dif)))
make_pretty(tidy(fit),
            nrows = nrow(tidy(fit)))
```

# Graphs




## Descriptive graphs

### Standardized difference

Rankings of highest absolute and standardized differences for IHME and WHO.


```{r}
temp <- df
temp <- temp %>% filter(!is.na(w_minus_i)) %>% arrange(w_minus_i)
temp <- temp[c(1:10,
               (nrow(temp) - 9):nrow(temp)),]
temp$country <- factor(temp$country,
                       levels = temp$country)

# Clean up country names
ggplot(data = temp,
       aes(x = country,
           y = w_minus_i)) +
  geom_bar(stat = 'identity',
           fill = 'darkorange',
           alpha = 0.6) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90)) +
  ylab('Deaths') +
  xlab('Country') +
  ggtitle('Absolute differences: top and bottom 10') +
  labs(subtitle = '> 0 = WHO\'s estimate higher than IHME\'s')
```

```{r, eval = FALSE}
temp <- df
temp <- temp %>% filter(!is.na(stand_dif)) %>% arrange(stand_dif)
temp <- temp[c(1:10,
               (nrow(temp) - 9):nrow(temp)),]
temp$country <- factor(temp$country,
                       levels = temp$country)
ggplot(data = temp,
       aes(x = country,
           y = stand_dif)) +
  geom_bar(stat = 'identity',
           fill = 'darkorange',
           alpha = 0.6) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90)) +
  ylab('Standardized difference') +
  xlab('Country') +
  ggtitle('Standardized difference: top and bottom 10') 
```


```{r}
temp <- df
temp <- temp %>% filter(!is.na(adjusted_stand_dif)) %>% arrange(adjusted_stand_dif)
temp <- temp[c(1:10,
               (nrow(temp) - 9):nrow(temp)),]
temp$country <- factor(temp$country,
                       levels = temp$country)
ggplot(data = temp,
       aes(x = country,
           y = adjusted_stand_dif)) +
  geom_bar(stat = 'identity',
           fill = 'darkorange',
           alpha = 0.6) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90)) +
  ylab('Adjusted standardized difference') +
  xlab('Country') +
  ggtitle('Adjusted standardized difference: top and bottom 10') 
```

```{r}
temp <- df
temp <- temp %>% filter(!is.na(original_stand_dif)) %>% arrange(original_stand_dif)
temp <- temp[c(1:10,
               (nrow(temp) - 9):nrow(temp)),]
temp$country <- factor(temp$country,
                       levels = temp$country)
ggplot(data = temp,
       aes(x = country,
           y = original_stand_dif)) +
  geom_bar(stat = 'identity',
           fill = 'darkorange',
           alpha = 0.6) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90)) +
  ylab('Standardized difference') +
  xlab('Country') +
  labs(title = 'Standardized difference: top and bottom 10',
       subtitle = 'Figure 1b') 
```

```{r}
temp <- df
temp <- temp %>% filter(!is.na(stand_dif_sqrt_directional)) %>% arrange(stand_dif_sqrt_directional)
temp <- temp[c(1:10,
               (nrow(temp) - 9):nrow(temp)),]
temp$country <- factor(temp$country,
                       levels = temp$country)
ggplot(data = temp,
       aes(x = country,
           y = stand_dif_sqrt_directional)) +
  geom_bar(stat = 'identity',
           fill = 'darkorange',
           alpha = 0.6) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90)) +
  ylab('Square-root standardized difference') +
  xlab('Country') +
  ggtitle('Square root standardized difference: top and bottom 10') 
```


### Standardized difference for incidence

```{r}
# Standardized difference for incidence
temp <- df
temp <- temp %>% filter(!is.na(stand_dif_inc_adj)) %>% arrange(stand_dif_inc_adj) %>%
  filter(is.finite(stand_dif_inc_adj))
temp <- temp[c(1:10,
               (nrow(temp) - 9):nrow(temp)),]
temp$country <- factor(temp$country,
                       levels = temp$country)
ggplot(data = temp,
       aes(x = country,
           y = stand_dif_inc_adj)) +
  geom_bar(stat = 'identity',
           fill = 'darkorange',
           alpha = 0.6) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90)) +
  ylab('Adjusted standardized incidence difference') +
  xlab('Country') +
  ggtitle('Adjusted standardized incidence difference: top and bottom 10') 
```


```{r, eval = FALSE}
temp <- df
temp <- temp %>% filter(!is.na(stand_dif_inc)) %>% arrange(stand_dif_inc)
temp <- temp[c(1:10,
               (nrow(temp) - 9):nrow(temp)),]
temp$country <- factor(temp$country,
                       levels = temp$country)
ggplot(data = temp,
       aes(x = country,
           y = stand_dif_inc)) +
  geom_bar(stat = 'identity',
           fill = 'darkorange',
           alpha = 0.6) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90)) +
  ylab('Stan. dif. inc') +
  xlab('Country') +
  ggtitle('Standardized incidence difference: top and bottom 10') 
```






### AB metric (a-b) / (a+b)

Rankings of highest absolute and standardized differences for IHME and WHO.

```{r, eval = FALSE}
temp <- df
temp <- temp %>% filter(!is.na(ab)) %>% arrange(ab)
temp <- temp[c(1:10,
               (nrow(temp) - 9):nrow(temp)),]
temp$country <- factor(temp$country,
                       levels = temp$country)
ggplot(data = temp,
       aes(x = country,
           y = ab)) +
  geom_bar(stat = 'identity',
           fill = 'darkorange',
           alpha = 0.6) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90)) +
  ylab('AB') +
  xlab('Country') +
  ggtitle('AB: top and bottom 10') 
```


```{r}
temp <- df
temp <- temp %>% filter(!is.na(adjusted_ab)) %>% arrange(adjusted_ab)
temp <- temp[c(1:10,
               (nrow(temp) - 9):nrow(temp)),]
temp$country <- factor(temp$country,
                       levels = temp$country)
ggplot(data = temp,
       aes(x = country,
           y = adjusted_ab)) +
  geom_bar(stat = 'identity',
           fill = 'darkorange',
           alpha = 0.6) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90)) +
  ylab('Adjusted AB') +
  xlab('Country') +
  ggtitle('Adjusted AB: top and bottom 10') 
```

```{r}
temp <- df
temp <- temp %>% filter(!is.na(ab_sqrt_directional)) %>% arrange(ab_sqrt_directional)
temp <- temp[c(1:10,
               (nrow(temp) - 9):nrow(temp)),]
temp$country <- factor(temp$country,
                       levels = temp$country)
ggplot(data = temp,
       aes(x = country,
           y = ab_sqrt_directional)) +
  geom_bar(stat = 'identity',
           fill = 'darkorange',
           alpha = 0.6) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90)) +
  ylab('Square-root AB') +
  xlab('Country') +
  ggtitle('Square root AB: top and bottom 10') 
```



# Maps


```{r}
# Expand
world_tidy <- broom::tidy(world, region = 'iso_a3')
# Join in data
world@data <-
  left_join(x = world@data,
            y = df,
            by = c('iso_a3' = 'iso3'))
# Join to the tidy version too
world_tidy <-
  left_join(x = world_tidy,
            y = df,
            by = c('id' = 'iso3'))

# Remove those which are unknown
world_tidy <- world_tidy %>%
  filter(id != '-99',
         !is.na(country))
```


```{r}
# Absolute differences by country
# Plot
g1 <- 
  ggplot(data = world_tidy,
       aes(x = long,
           y = lat,
           group = group,
           fill = absolute_difference)) +
  coord_map() +
  geom_polygon(color = 'black',  size = 0.1) +
  # theme_cism() +
  scale_fill_gradient2(low = 'darkgreen',
                       mid = 'white',
                         high = 'darkorange',
                       na.value = 'white',
                       name = '') +
  labs(x = 'Longitude',
       y = 'Latitude',
       title = 'Absolute difference by country') +
  theme_bw()
g1


# Clean up
# Make NA countries look cleaner with a shaded



# Plot
g1 <- 
  ggplot(data = world_tidy,
       aes(x = long,
           y = lat,
           group = group,
           fill = stand_dif)) +
  coord_map() +
  geom_polygon(color = 'black',  size = 0.1) +
  # theme_cism() +
  scale_fill_gradient2(low = 'darkgreen',
                       mid = 'white',
                         high = 'darkorange',
                       na.value = 'white',
                       name = '') +
  labs(x = 'Longitude',
       y = 'Latitude',
       title = 'Standardized difference by country') +
  theme_bw()
g1

```

```{r}
# Clean up
# Make NA countries look cleaner with a shaded

# Plot
g1 <- 
  ggplot(data = world_tidy,
       aes(x = long,
           y = lat,
           group = group,
           fill = adjusted_stand_dif)) +
  coord_map() +
  geom_polygon(color = 'black',  size = 0.1) +
  # theme_cism() +
  scale_fill_gradient2(low = 'darkgreen',
                       mid = 'white',
                         high = 'darkorange',
                       na.value = 'white',
                       name = '') +
  labs(x = 'Longitude',
       y = 'Latitude',
       title = 'Adjusted standardized difference by country') +
  theme_bw()
g1

```



```{r}

# Plot
ggplot(data = world_tidy,
       aes(x = long,
           y = lat,
           group = group,
           fill = stand_dif_sqrt_directional)) +
  coord_map() +
  geom_polygon(color = 'black',  size = 0.1) +
  # theme_cism() +
  # scale_fill_continuous(low="thistle2", high="darkred", 
  #                      guide="colorbar",na.value="white") +
  scale_fill_gradient2(low = 'darkgreen',
                       mid = 'white',
                         high = 'darkorange',
                       na.value = 'white',
                       name = '') +
  labs(x = 'Longitude',
       y = 'Latitude',
       title = 'Square root of standardized difference by country') +
  theme_bw()
```


```{r}

# Plot
ggplot(data = world_tidy,
       aes(x = long,
           y = lat,
           group = group,
           fill = ab_sqrt_directional)) +
  coord_map() +
  geom_polygon(color = 'black',  size = 0.1) +
  # theme_cism() +
  # scale_fill_continuous(low="thistle2", high="darkred", 
  #                      guide="colorbar",na.value="white") +
  scale_fill_gradient2(low = 'darkgreen',
                       mid = 'white',
                         high = 'darkorange',
                       na.value = 'white',
                       name = '') +
  labs(x = 'Longitude',
       y = 'Latitude',
       title = 'Square root of AB by country') +
  theme_bw()
```


The below scatterplot shows the correlation between WHO (x-axis) estimates and IHME (y-axis) estimates, with each point colored by its (WHO-defined) region. 

```{r}
cols <- colorRampPalette(brewer.pal(n = 9, name = 'Spectral'))(length(unique(df$who_region)))
ggplot(data = df,
       aes(x = w_both_all_tbtotal_nd,
           y = i_both_all_tbtotal_nd,
           color = who_region)) +
  geom_point(alpha = 0.6) +
  theme_bw() +
    scale_y_log10(limits = c(1, 150000)) +
  scale_x_log10(limits = c(1, 150000)) +
  labs(x = 'WHO',
       y = 'IHME',
       title = 'Correlation between WHO and IHME mortality esimates',
       subtitle = 'Log scale, includes both TB and TB+HIV cases') +
   geom_line(stat = 'smooth', 
             method='lm', se = FALSE, alpha = 0.6,
               formula = y ~ x) +
  geom_abline(color = 'black',
              lty = 2,
              alpha = 0.6) +
  scale_color_manual(name = 'Region',
                     values = cols)

```


## Analytical for adjusted_stand_dif


In the following four charts, Libya has been excluded as an outlier.



### a) HIV prevalence among TB cases

```{r}
# x = df$newrel_hivpos
# y = adjusted stand_dif

# Fix log adjusted stand_dif so as to have a log-usable
# negative number
ggplot(data = df,
       aes(x = adjusted_stand_dif,  #stand_dif_sqrt_directional,
           y = p_hiv_of_tb)) +
  geom_point(alpha = 0.6) +
  theme_bw() +
    # scale_y_log10() +
  labs(x = 'Adjusted standardized difference',
       y = 'HIV prevalence among new TB cases',
       title = 'Association of standardized difference with HIV') +
  # xlim(-10,40) +
     geom_smooth(method='lm', se = FALSE, alpha = 0.2,
               formula = y ~ x) 
```


### b) Rifampicine resistance (MDR prevalence)

```{r}
ggplot(data = df,
       aes(x = adjusted_stand_dif,
           y = p_mdr_new)) +
  geom_point(alpha = 0.6) +
  theme_bw() +
    # scale_y_log10() +
    labs(x = 'Adjusted standardized difference',
       y = 'MDR prevalence among new cases',
       title = 'Association of standardized difference with MDR prevalence') +
    # xlim(-10,40) +
     geom_smooth(method='lm', se = FALSE, alpha = 0.2,
               formula = y ~ x) 

```


### b.i) Rifampicine resistance (MDR prevalence using reported cases)

```{r}
ggplot(data = df,
       aes(x = adjusted_stand_dif,
           y = reported_mdr)) +
  geom_point(alpha = 0.6) +
  theme_bw() +
    # scale_y_log10() +
    labs(x = 'Adjusted standardized difference',
       y = 'MDR prevalence among new cases',
       title = 'Association of standardized difference with MDR prevalence (reported)') +
    # xlim(-10,40) +
     geom_smooth(method='lm', se = FALSE, alpha = 0.2,
               formula = y ~ x) 

```

### c) CDR (case detection rate per WHO)

```{r}
ggplot(data = df,
       aes(x = adjusted_stand_dif,
           y = gb_c_cdr)) +
  geom_point(alpha = 0.6) +
  theme_bw() +
   geom_smooth(method='lm', se = FALSE, alpha = 0.2,
               formula = y ~ x) +
      labs(x = 'Adjusted standardized difference',
       y = 'Case detection rate',
       title = 'Association of standardized difference with case detection rate') #+
    # xlim(-10,40)


# Those countries with low case detection (oftentimes have prev survey),
# WHO estimates more deaths than IHME
```


### c.i) CDR (case detection rate per IHME)

```{r}
# Create an IHME cdr variable
df$cdr_ihme <- 
  (df$c_newinc + df$ret_nrel) / 
  df$ihme_incidence_both_allages_totaltb_number   * 100
  

ggplot(data = df,
       aes(x = adjusted_stand_dif,
           y = cdr_ihme)) +
  geom_point(alpha = 0.6) +
  theme_bw() +
   geom_smooth(method='lm', se = FALSE, alpha = 0.2,
               formula = y ~ x) +
      labs(x = 'Adjusted standardized difference',
       y = 'Case detection rate',
       title = 'Association of standardized difference with case detection rate') +
    # xlim(-10,40) +
  ylim(0, 100)


# Those countries with low case detection (oftentimes have prev survey),
# WHO estimates more deaths than IHME
```

### c.ii) Correlation between different case detections rates

```{r}
library(ggrepel)
ggplot(data = df,
       aes(x = gb_c_cdr,
           y = cdr_ihme)) +
  geom_point(alpha = 0.3) +
  theme_bw() +
   geom_smooth(method='lm', se = FALSE, alpha = 0.2,
               formula = y ~ x) +
      labs(x = 'WHO case detection rate',
       y = 'IHME case detection rate',
       title = 'Association of two case detection rates') +
  geom_text(aes(label = country),
                   size = 3,
            alpha = 0.6)

```

### d) CFR (case fatality rate)

```{r}
ggplot(data = df,
       aes(x = adjusted_stand_dif,
           y = case_fatality_rate_2015_adjusted)) +
  geom_point(alpha = 0.6) +
  theme_bw() +
  labs(x = 'Adjusted standardized difference',
       y = 'Case fatality rate',
       title = 'Association of standardized difference with case fatality rate') +
  # xlim(-10, 40) +
     geom_smooth(method='lm', se = FALSE, alpha = 0.2,
               formula = y ~ x) 

```


### Prevalence survey's effect

```{r}
ggplot(data = df,
       aes(x = who_region,
           y = adjusted_stand_dif)) +
  geom_boxplot() +
  # ylim(-10, 20) +
  geom_jitter(alpha = 0.3, size = 0.5) +
  theme_bw() +
  labs(x = 'Region',
       y = 'Adjusted standardized difference',
       title = 'Adjusted standardized difference by WHO region')
  # geom_violin()
```

```{r}
ggplot(data = df,
       aes(x = who_region,
           y = adjusted_stand_dif)) +
  # geom_boxplot() +
  # ylim(-10, 20) +
  theme_bw() +
  labs(x = 'Region',
       y = 'Adjusted standardized difference',
       title = 'Adjusted standardized difference by WHO region') +
  geom_violin() +
  geom_jitter(alpha = 0.3, size = 0.5) 
```

### Association of prevalence survey and standardized difference

```{r}
ggplot(data = df,
       aes(x = factor(prevsurvey),
           y = adjusted_stand_dif)) +
  geom_boxplot() +
  # ylim(-10, 20) +
  geom_jitter(alpha = 0.3) +
  theme_bw() +
  labs(x = 'Prevalence survey',
       y = 'Adjusted standardized difference',
       title = 'Association of prevalence survey and adjusted standardized difference')
  # geom_violin()
```




## Analytical for stand_dif_inc_adj



### a) HIV prevalence among TB cases

```{r}
# x = df$newrel_hivpos
# y = adjusted stand_dif

# Fix log adjusted stand_dif so as to have a log-usable
# negative number
ggplot(data = df,
       aes(x = stand_dif_inc_adj,  #stand_dif_sqrt_directional,
           y = p_hiv_of_tb)) +
  geom_point(alpha = 0.6) +
  theme_bw() +
    # scale_y_log10() +
  labs(x = 'Adj. stand. dif. in inc.',
       y = 'HIV prevalence among new TB cases',
       title = 'Association of Adj. stand. dif. in inc. with HIV') +
  # xlim(-10,40) +
     geom_smooth(method='lm', se = FALSE, alpha = 0.2,
               formula = y ~ x) 
```


### b) Rifampicine resistance (MDR prevalence)

```{r}
ggplot(data = df,
       aes(x = stand_dif_inc_adj,
           y = p_mdr_new)) +
  geom_point(alpha = 0.6) +
  theme_bw() +
    # scale_y_log10() +
    labs(x = 'Adj. stand. dif. in inc.',
       y = 'MDR prevalence among new cases',
       title = 'Association of Adj. stand. dif. in inc. with MDR prevalence') +
    # xlim(-10,40) +
     geom_smooth(method='lm', se = FALSE, alpha = 0.2,
               formula = y ~ x) 

```


### b.i) Rifampicine resistance (MDR prevalence using reported cases)

```{r}
ggplot(data = df,
       aes(x = stand_dif_inc_adj,
           y = reported_mdr)) +
  geom_point(alpha = 0.6) +
  theme_bw() +
    # scale_y_log10() +
    labs(x = 'Adj. stand. dif. in inc.',
       y = 'MDR prevalence among new cases',
       title = 'Association of Adj. stand. dif. in inc. with MDR prevalence (reported)') +
    # xlim(-10,40) +
     geom_smooth(method='lm', se = FALSE, alpha = 0.2,
               formula = y ~ x) 

```

### c) CDR (case detection rate per WHO)

```{r}
ggplot(data = df,
       aes(x = stand_dif_inc_adj,
           y = gb_c_cdr)) +
  geom_point(alpha = 0.6) +
  theme_bw() +
   geom_smooth(method='lm', se = FALSE, alpha = 0.2,
               formula = y ~ x) +
      labs(x = 'Adj. stand. dif. in inc.',
       y = 'Case detection rate',
       title = 'Association of Adj. stand. dif. in inc.') +
    # xlim(-10,40)


# Those countries with low case detection (oftentimes have prev survey),
# WHO estimates more deaths than IHME
```


### c.i) CDR (case detection rate per IHME)

```{r}
# Create an IHME cdr variable
df$cdr_ihme <- 
  (df$c_newinc + df$ret_nrel) / 
  df$ihme_incidence_both_allages_totaltb_number   * 100
  

ggplot(data = df,
       aes(x = stand_dif_inc_adj,
           y = cdr_ihme)) +
  geom_point(alpha = 0.6) +
  theme_bw() +
   geom_smooth(method='lm', se = FALSE, alpha = 0.2,
               formula = y ~ x) +
      labs(x = 'Adj. stand. dif. in inc.',
       y = 'Case detection rate',
       title = 'Association of Adj. stand. dif. in inc. with case detection rate') #+
    # xlim(-10,40) +
  # ylim(0, 100)


# Those countries with low case detection (oftentimes have prev survey),
# WHO estimates more deaths than IHME
```

### d) CFR (case fatality rate)

```{r}
ggplot(data = df,
       aes(x = stand_dif_inc_adj,
           y = case_fatality_rate_2015_adjusted)) +
  geom_point(alpha = 0.6) +
  theme_bw() +
  labs(x = 'Adj. stand. dif. in inc.',
       y = 'Case fatality rate',
       title = 'Association of Adj. stand. dif. in inc. with case fatality rate') +
  # xlim(-10, 40) +
     geom_smooth(method='lm', se = FALSE, alpha = 0.2,
               formula = y ~ x) 

```


### Prevalence survey's effect

```{r}
ggplot(data = df,
       aes(x = who_region,
           y = stand_dif_inc_adj)) +
  geom_boxplot() +
  # ylim(-10, 20) +
  geom_jitter(alpha = 0.3, size = 0.5) +
  theme_bw() +
  labs(x = 'Region',
       y = 'Adj. stand. dif. in inc.',
       title = 'Adj. stand. dif. in inc. by WHO region')
  # geom_violin()
```

```{r}
ggplot(data = df,
       aes(x = who_region,
           y = stand_dif_inc_adj)) +
  # geom_boxplot() +
  # ylim(-10, 20) +
  theme_bw() +
  labs(x = 'Region',
       y = 'Adj. stand. dif. in inc.',
       title = 'Adj. stand. dif. in inc. by WHO region') +
  geom_violin() +
  geom_jitter(alpha = 0.3, size = 0.5) 
```

### Association of prevalence survey and standardized difference

```{r}
ggplot(data = df,
       aes(x = factor(prevsurvey),
           y = stand_dif_inc_adj)) +
  geom_boxplot() +
  # ylim(-10, 20) +
  geom_jitter(alpha = 0.3) +
  theme_bw() +
  labs(x = 'Prevalence survey',
       y = 'Adj. stand. dif. in inc.',
       title = 'Association of prevalence survey and Adj. stand. dif. in inc.')
  # geom_violin()
```




## Analytical for adjusted_ab


### a) HIV prevalence among TB cases

```{r}
# x = df$newrel_hivpos
# y = adjusted ab

# Fix log adjusted ab so as to have a log-usable
# negative number
ggplot(data = df,
       aes(x = adjusted_ab,  #ab_sqrt_directional,
           y = p_hiv_of_tb)) +
  geom_point(alpha = 0.6) +
  theme_bw() +
    # scale_y_log10() +
  labs(x = 'Adjusted AB',
       y = 'HIV prevalence among new TB cases',
       title = 'Association of AB with HIV') +
  # xlim(-10,40) +
     geom_smooth(method='lm', se = FALSE, alpha = 0.2,
               formula = y ~ x) 
```


### b) Rifampicine resistance (MDR prevalence)

```{r}
ggplot(data = df,
       aes(x = adjusted_ab,
           y = p_mdr_new)) +
  geom_point(alpha = 0.6) +
  theme_bw() +
    # scale_y_log10() +
    labs(x = 'Adjusted AB',
       y = 'MDR prevalence among new cases',
       title = 'Association of AB with MDR prevalence') +
    # xlim(-10,40) +
     geom_smooth(method='lm', se = FALSE, alpha = 0.2,
               formula = y ~ x) 

```


### b.i) Rifampicine resistance (MDR prevalence using reported cases)

```{r}
ggplot(data = df,
       aes(x = adjusted_ab,
           y = reported_mdr)) +
  geom_point(alpha = 0.6) +
  theme_bw() +
    # scale_y_log10() +
    labs(x = 'Adjusted AB',
       y = 'MDR prevalence among new cases',
       title = 'Association of adjusted AB with MDR prevalence (reported)') +
    # xlim(-10,40) +
     geom_smooth(method='lm', se = FALSE, alpha = 0.2,
               formula = y ~ x) 

```

### c) CDR (case detection rate per WHO)

```{r}
ggplot(data = df,
       aes(x = adjusted_ab,
           y = gb_c_cdr)) +
  geom_point(alpha = 0.6) +
  theme_bw() +
   geom_smooth(method='lm', se = FALSE, alpha = 0.2,
               formula = y ~ x) +
      labs(x = 'Adjusted AB',
       y = 'Case detection rate',
       title = 'Association of AB with case detection rate') #+
    # xlim(-10,40)

```


### c.i) CDR (case detection rate per IHME)

```{r}
# Create an IHME cdr variable
df$cdr_ihme <- 
  (df$c_newinc + df$ret_nrel) / 
  df$ihme_incidence_both_allages_totaltb_number   * 100
  

ggplot(data = df,
       aes(x = adjusted_ab,
           y = cdr_ihme)) +
  geom_point(alpha = 0.6) +
  theme_bw() +
   geom_smooth(method='lm', se = FALSE, alpha = 0.2,
               formula = y ~ x) +
      labs(x = 'Adjusted AB difference',
       y = 'Case detection rate',
       title = 'Association of adjusted AB with case detection rate') #+
    # xlim(-10,40) +
  # ylim(0, 100)

```

### d) CFR (case fatality rate)

```{r}
ggplot(data = df,
       aes(x = adjusted_ab,
           y = case_fatality_rate_2015_adjusted)) +
  geom_point(alpha = 0.6) +
  theme_bw() +
  labs(x = 'Adjusted AB',
       y = 'Case fatality rate',
       title = 'Association of adjusted AB with case fatality rate') +
  # xlim(-10, 40) +
     geom_smooth(method='lm', se = FALSE, alpha = 0.2,
               formula = y ~ x) 

```


### Prevalence survey's effect

```{r}
ggplot(data = df,
       aes(x = who_region,
           y = adjusted_ab)) +
  geom_boxplot() +
  # ylim(-10, 20) +
  geom_jitter(alpha = 0.3, size = 0.5) +
  theme_bw() +
  labs(x = 'Region',
       y = 'Adjusted AB',
       title = 'Adjusted AB by WHO region')
  # geom_violin()
```

```{r}
ggplot(data = df,
       aes(x = who_region,
           y = adjusted_ab)) +
  # geom_boxplot() +
  # ylim(-10, 20) +
  theme_bw() +
  labs(x = 'Region',
       y = 'Adjusted AB',
       title = 'Adjusted AB') +
  geom_violin() +
  geom_jitter(alpha = 0.3, size = 0.5) 
```

### Association of prevalence survey and standardized difference

```{r}
ggplot(data = df,
       aes(x = factor(prevsurvey),
           y = adjusted_ab)) +
  geom_boxplot() +
  # ylim(-10, 20) +
  geom_jitter(alpha = 0.3) +
  theme_bw() +
  labs(x = 'Prevalence survey',
       y = 'Adjusted AB',
       title = 'Association of prevalence survey and adjusted AB')
  # geom_violin()
```


## Modeling

Linear regression to estimate effect of prevalence survey on absolute difference in cases (WHO minus IHME), adjusting for region.

```{r}
# fit <- glm(prevsurvey ~ stand_dif, data = df %>% filter(is.finite(stand_dif)), family = binomial('logit'))
# summary(fit)
# exp(coef(fit))
# exp(confint(fit))
# 
fit <- lm(w_minus_i ~ prevsurvey + who_region, data = df %>% filter(is.finite(w_minus_i)))
make_pretty(tidy(summary(fit)), nrows = nrow(tidy(summary(fit))))
```

95% confidence intervals

```{r}
make_pretty(tidy(confint(fit)))
```


Linear regression to estimate effect of prevalence survey on adjusted standardized difference in cases, adjusting for region.

```{r}

fit <- lm(adjusted_stand_dif ~ prevsurvey + who_region, data = df %>% filter(is.finite(w_minus_i)))
make_pretty(tidy(summary(fit)), nrows = nrow(tidy(summary(fit))))
```

95% confidence intervals

```{r}
make_pretty(tidy(confint(fit)))
```


# Interactive map

## Relative difference (function of maximum estimate)

(Unfinished)

```{r}
library(leaflet)
world@data$indicator <- (world@data$adjusted_stand_dif)
qpal <- colorNumeric("Spectral", 
                     world@data$indicator, na.color = "#bdbdbd")


popup <- paste0("<strong>Country: </strong>",
                    world@data$country,
                    "<br><strong>WHO: </strong>",
                    round(world@data$w_both_all_tbtotal_nd, digits = 2),
                    "<br><strong>IHME: </strong>",
                    round(world@data$i_both_all_tbtotal_nd, digits = 2),
                "<br><strong>Relative difference: </strong>",
                round(world@data$relative_difference, digits = 3),
                "<br><strong>WHO / IHME: </strong>",
                round(world@data$w_over_i, digits = 3),
                "<br><strong>IHME / WHO: </strong>",
                round(world@data$i_over_w, digits = 3),
                "<br><strong>Absolute difference: </strong>",
                round(world@data$absolute_difference, digits = 3),
                "<br><strong>Adjusted standardized difference: </strong>",
                round(world@data$adjusted_stand_dif, digits = 3)
                )

leaflet(data = world) %>%
  addProviderTiles("Stamen.TonerBackground") %>% 
  setView(lng = mean(coordinates(world)[,1]),
          lat = mean(coordinates(world)[,2]),
          zoom = 2) %>%
  # clearShapes() %>% 
  # clearControls() %>% 
  addPolygons(data = world, 
              fillColor = ~qpal(adjusted_stand_dif), fillOpacity = 0.7, 
              color = "white", weight = 2, popup = popup) %>%
  addLegend(pal = qpal, 
            values = ~indicator, opacity = 0.9,
            position = 'bottomright',
            title = paste0('Adjusted standardized difference', "<br>"))
```

## Map of world

```{r}
library(ggthemes)
x <- map_data('world')
x$moz <- x$region == 'Mozambique'
ggplot(data = x,
       aes(x = long,
           y = lat,
           group = group)) +
  geom_polygon(aes(fill = moz)) +
  scale_fill_manual(name = '',
                     values = c('black', 'darkred'),
                    guide = FALSE) +
  theme_map() 


```

## Map of Mozambique

```{r}
x <- map_data('world')
x <- x[x$region == 'Mozambique',]
ggplot(data = x,
       aes(x = long,
           y = lat,
           group = group)) +
  geom_polygon(fill = 'darkred') +
  theme_map() +
  coord_map()
```

## Correlation coefficients

Correlation of adjusted stand diff with a) HIV prevalence, CDR by both, CFR, MDR prevalence.

```{r, echo = TRUE}
cor(df$adjusted_stand_dif, df$newrel_hivpos, use = 'complete.obs')
cor(df$adjusted_stand_dif, df$gb_c_cdr, use = 'complete.obs')
cor(df$adjusted_stand_dif, df$cdr_ihme, use = 'complete.obs')
cor(df$adjusted_stand_dif, df$case_fatality_rate_2014, use = 'complete.obs')
cor(df$adjusted_stand_dif, df$case_fatality_rate_2012_to_2014, use = 'complete.obs')
cor(df$adjusted_stand_dif, df$case_fatality_rate_2015, use = 'complete.obs')
cor(df$adjusted_stand_dif, df$case_fatality_rate_2014_new, use = 'complete.obs')
cor(df$adjusted_stand_dif, df$case_fatality_rate_2012_to_2014_new, use = 'complete.obs')
cor(df$adjusted_stand_dif, df$case_fatality_rate_2015_new, use = 'complete.obs')
cor(df$adjusted_stand_dif, df$case_fatality_rate_2015_adjusted, use = 'complete.obs')
cor(df$adjusted_stand_dif, df$p_mdr_new, use = 'complete.obs')
cor(df$adjusted_stand_dif, df$reported_mdr, use = 'complete.obs')
```

## Hypothesis testing on prevalence survey

Does region affect likelihood of having a prevalence survey?

```{r, echo = TRUE}
xt <- table(df$prevsurvey, df$who_region)
xt
chisq.test(xt)
```

Does having a prev survey affect the adjusted stand diff?

```{r, echo = TRUE}
t.test(x = df$adjusted_stand_dif[df$prevsurvey == 0],
       y = df$adjusted_stand_dif[df$prevsurvey == 1])
```